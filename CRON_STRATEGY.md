# Cron実行戦略ドキュメント

## 📋 概要

GitHub Actionsを使用した定期的なサイトチェックの実行戦略です。

---

## 🎯 実行戦略

### **1. バッチサイズ制限**

- **1回の実行で最大10サイトまで**チェック
- タイムアウト回避（1サイト平均10秒 × 10 = 100秒 < GitHub Actions 6分制限）

### **2. プラン考慮**

各ユーザーのプランに応じた `daily_check_limit` を尊重：

| プラン | 1日のチェック回数上限 |
|--------|----------------------|
| Free | 1回 |
| Pro | 5回 |
| Business | 無制限（999回） |

### **3. 優先順位付け**

チェック対象サイトの優先順位：

1. **プラン優先度**: Business > Pro > Free
2. **最終チェック時刻**: 古い順（未チェックを最優先）

**優先度スコア計算式:**
```typescript
priority = planPriority × 1000 + ageInHours
// planPriority: Business=3, Pro=2, Free=1
// ageInHours: 最終チェックからの経過時間
```

### **4. 実行頻度**

**1日3回実行**（8時間ごと）:

| 時刻 (UTC) | 時刻 (JST) | 用途 |
|-----------|-----------|------|
| 00:00 | 09:00 | 朝のチェック |
| 08:00 | 17:00 | 夕方のチェック |
| 16:00 | 01:00 | 深夜のチェック |

---

## 📊 実行フロー

```
1. アクティブなサイトを全取得
   └─ user_id, plan, last_checked_at を含む

2. 今日のチェック回数を集計
   └─ ユーザーごとに site_check_history からカウント

3. プラン制限でフィルタリング
   └─ checkCount < daily_check_limit のサイトのみ

4. 優先順位でソート
   └─ プラン優先度 > 最終チェック時刻

5. 上位10サイトを選択
   └─ バッチサイズ制限

6. 順次チェック実行
   └─ 各サイト間に2秒待機（レート制限対策）
```

---

## 🔍 実行例

### **シナリオ1: 少数サイト**

**状況:**
- Free ユーザーA: サイト3つ（未チェック）
- Pro ユーザーB: サイト2つ（6時間前チェック済み）

**00:00実行:**
1. ユーザーB（Pro）のサイト2つをチェック ✅
2. ユーザーA（Free）のサイト1つをチェック ✅
3. 合計3サイトチェック

**08:00実行:**
1. ユーザーA（Free）の残り2サイトは既に1回チェック済み → スキップ
2. ユーザーB（Pro）のサイト2つを再チェック ✅（Pro: 5回/日まで可能）
3. 合計2サイトチェック

---

### **シナリオ2: 多数サイト**

**状況:**
- 合計50アクティブサイト
- 内訳: Free 30サイト, Pro 15サイト, Business 5サイト

**00:00実行:**
1. Business 5サイトを優先チェック ✅
2. Pro 5サイトをチェック ✅（上位10に到達）
3. 合計10サイトチェック

**08:00実行:**
1. Business 5サイトを再チェック ✅
2. Pro 5サイト（未チェックまたは2回目）をチェック ✅
3. 合計10サイトチェック

**16:00実行:**
1. Pro残り5サイトをチェック ✅
2. Free 5サイト（未チェック）をチェック ✅
3. 合計10サイトチェック

**結果:**
- 1日で合計30サイトチェック
- 残りFree 25サイトは翌日以降に順次チェック

---

## ⚠️ 制約と注意事項

### **GitHub Actions制限**

- **タイムアウト**: 6分/実行
- **実行回数**: 無制限（Publicリポジトリ）
- **同時実行**: 1つのワークフローのみ

### **Vercel制限（Proプラン）**

- **関数タイムアウト**: 60秒
- **関数メモリ**: 3008 MB
- **同時実行**: 無制限（料金に応じて）

### **Lambda制限**

- **タイムアウト**: 設定可能（推奨: 30秒）
- **メモリ**: 設定可能（推奨: 1024 MB）
- **同時実行**: 1000（デフォルト）

---

## 🚀 スケーリング戦略

### **短期（現在の実装）**

- ✅ バッチサイズ: 10サイト
- ✅ 実行頻度: 3回/日
- ✅ カバレッジ: 最大30サイト/日

**適用範囲:** ~100サイトまで対応可能

---

### **中期（次のステップ）**

#### **オプション1: 並列実行**

```typescript
// Promise.all で複数サイトを同時チェック
await Promise.all(
  sitesToCheck.map(site => checkSite(site))
);
```

**メリット:** チェック時間を大幅短縮
**デメリット:** Lambdaコスト増加、レート制限リスク

---

#### **オプション2: 動的バッチサイズ**

```typescript
// サイト数に応じてバッチサイズを調整
const batchSize = Math.min(
  Math.floor(300 / avgCheckTime), // 5分以内に収める
  20 // 最大20サイト
);
```

---

### **長期（将来の拡張）**

#### **キューシステム導入**

```typescript
// Cronはキューに追加するだけ
// バックグラウンドワーカーが処理
// 例: BullMQ, AWS SQS, Supabase Realtime
```

**メリット:**
- スケーラビリティ
- リトライ機能
- 優先度制御

**デメリット:**
- インフラ複雑化
- コスト増加

---

## 📈 モニタリング

### **確認すべき指標**

1. **実行成功率**: `success / total`
2. **平均実行時間**: バッチあたり
3. **チェック済みサイト数**: 1日あたり
4. **タイムアウト発生率**: エラーログから確認

### **アラート設定**

- ✅ 実行失敗が3回連続
- ✅ 平均実行時間が5分超過
- ✅ タイムアウト発生率が20%超過

---

## 🔧 トラブルシューティング

### **問題1: タイムアウトが頻発**

**原因:**
- Lambda/スクレイピングが遅い
- 重いサイトが多い

**対処:**
1. バッチサイズを減らす（10 → 5）
2. Lambda のメモリを増やす
3. タイムアウトの長いサイトを特定して除外

---

### **問題2: 一部のサイトがチェックされない**

**原因:**
- プラン制限により優先度が低い
- 常に新しいサイトが追加される

**対処:**
1. Cronの実行頻度を増やす（4回/日）
2. バッチサイズを増やす（15-20）
3. Freeユーザーの制限を緩和（2回/日など）

---

### **問題3: プラン制限を超えてチェックされている**

**原因:**
- `site_check_history` のカウントロジックが不正確
- タイムゾーンの問題

**対処:**
1. カウントクエリを確認（今日 00:00 UTC 基準）
2. ログで実際のチェック回数を確認
3. 必要に応じて `daily_check_count` カラムを追加

---

## 📚 関連ドキュメント

- [GitHub Secrets設定ガイド](./GITHUB_SECRETS_SETUP.md)
- [Supabase Schema](./supabase/schema.sql)
- [Lambda Handler](./lambda/handler.js)

---

## 🎉 まとめ

現在の実装で以下を実現：

✅ **タイムアウト回避**: 10サイト/回 × 3回/日 = 30サイト/日
✅ **プラン尊重**: ユーザーの daily_check_limit を考慮
✅ **優先度制御**: Proユーザー優先、古いサイト優先
✅ **スケーラブル**: 100サイト程度まで対応可能

将来的には並列実行やキューシステムでさらなるスケールが可能です！🚀
