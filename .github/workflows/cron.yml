# GitHub Actions Cron
# 1æ—¥3å›å®Ÿè¡Œï¼ˆ8æ™‚é–“ã”ã¨ï¼‰
name: Daily Site Check

on:
  schedule:
    # 00:00 UTC (09:00 JST) - æœ
    - cron: '0 0 * * *'
    # 08:00 UTC (17:00 JST) - å¤•æ–¹
    - cron: '0 8 * * *'
    # 16:00 UTC (01:00 JST) - æ·±å¤œ
    - cron: '0 16 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  check-sites:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Daily Check
        env:
          APP_URL: ${{ secrets.APP_URL }}
          SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ğŸš€ Starting daily check at $(date)"
          echo "ğŸ“¡ Calling: ${APP_URL}/api/cron/daily-check"
          
          # APIã‚’å‘¼ã³å‡ºã—ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
          # -L: ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’ãƒ•ã‚©ãƒ­ãƒ¼
          RESPONSE=$(curl -s -L -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer ${SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            "${APP_URL}/api/cron/daily-check")
          
          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’åˆ†é›¢
          HTTP_BODY=$(echo "$RESPONSE" | sed '$d')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          echo "ğŸ“Š HTTP Status: ${HTTP_CODE}"
          echo "ğŸ“„ Response: ${HTTP_BODY}"
          
          # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… Daily check completed successfully"
            exit 0
          else
            echo "âŒ Daily check failed with status ${HTTP_CODE}"
            echo "Response body: ${HTTP_BODY}"
            exit 1
          fi

